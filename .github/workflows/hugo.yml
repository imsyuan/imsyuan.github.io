# Sample workflow for building and deploying a Hugo site to GitHub Pages
name: Deploy Hugo site to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

# Default to bash
defaults:
  run:
    shell: bash

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.141.0
    steps:
      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb
      - name: Install Dart Sass
        run: sudo snap install dart-sass
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      - name: Install Node.js dependencies
        run: "[[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true"
#      - name: Inject Google Ads ID
#        run: echo 'googleAnalytics = "${{ secrets.GOOGLE_ANALYTICS_ID }}"' >> hugo.toml
      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
          TZ: America/Los_Angeles
          HUGO_GOOGLEANALYTICS: ${{ secrets.GOOGLE_ANALYTICS_ID }}
        run: |
          hugo \
            --gc \
            --minify \
            --environment production
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    outputs:
      url: ${{ steps.deployment.outputs.page_url }}  # å®šç¾©ä¸€å€‹åç‚º url çš„è¼¸å‡º
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    runs-on: ubuntu-latest
    needs: deploy  # ç¢ºä¿åœ¨éƒ¨ç½²æˆåŠŸå¾Œæ‰åŸ·è¡Œé€šçŸ¥
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            content/posts/**/*.md
          separator: "|"

      - name: Extract Post Info
        if: steps.changed-files.outputs.any_changed == 'true'
        id: post-info
        run: |
          # å–å¾—åŸºç¤ URL ä¸¦ç¢ºä¿ä½¿ç”¨ HTTPS
          BASE_URL="${{ needs.deploy.outputs.url }}"
          # ç§»é™¤çµå°¾æ–œç·š
          BASE_URL=${BASE_URL%/}
          # å°‡ http:// æ›¿æ›æˆ https://
          BASE_URL=${BASE_URL/http:\/\//https:\/\/}
        
          echo "åŸºç¤ URL: $BASE_URL"
          
          # é¡¯ç¤ºæ‰€æœ‰è®Šæ›´çš„æª”æ¡ˆä»¥ä¾¿åµéŒ¯
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          
          for file in $(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr '|' '\n'); do
            if [[ -f "$file" ]]; then
              # æå–æ–‡ç« æ¨™é¡Œ
              title=$(grep -m 1 "^title = " "$file" || echo "title: æ–°æ–‡ç« ")
              if [ $? -eq 0 ]; then
                echo "æ‰¾åˆ°æ¨™é¡Œè¡Œ: $title"
                # ç§»é™¤ title = å’Œå¼•è™Ÿ
                title=${title#*title = }  # ç§»é™¤ "title = " éƒ¨åˆ†
                title=${title#"'"}        # ç§»é™¤é–‹é ­çš„å–®å¼•è™Ÿ
                title=${title%"'"}        # ç§»é™¤çµå°¾çš„å–®å¼•è™Ÿ
                echo "è™•ç†å¾Œçš„æ¨™é¡Œ: $title"
              else
                echo "ç„¡æ³•æ‰¾åˆ°æ¨™é¡Œï¼Œä½¿ç”¨é è¨­å€¼"
                title="æ–°æ–‡ç« "
              fi
          
              # å¾æª”æ¡ˆè·¯å¾‘å»ºæ§‹ URL è·¯å¾‘
              url=${file#"content/"}
              url=${file%.md}
              url=${url%/*} 
          
              # æå– slug
              slug=$(grep -m 1 "^slug = " "$file" || echo "")
              if [ ! -z "$slug" ]; then
                slug=${slug#*slug = }
                slug=${slug#"'"}
                slug=${slug%"'"}
                echo "æ‰¾åˆ° slug: $slug"
              else
                # å¦‚æœæ²’æœ‰ slugï¼Œç”¨æª”æ¡ˆåä½œç‚ºå¾Œå‚™
                slug=$(basename "$file" .md)
                echo "ä½¿ç”¨æª”æ¡ˆåä½œç‚º slug: $slug"
              fi
          
              # è¨­å®šç’°å¢ƒè®Šæ•¸
              echo "POST_TITLE=$title" >> $GITHUB_ENV
              echo "POST_URL=$BASE_URL/$slug" >> $GITHUB_ENV
              echo "POST_COVER=$BASE_URL/$url/cover.png" >> $GITHUB_ENV
          
              # é¡¯ç¤ºè™•ç†çµæœä»¥ä¾¿åµéŒ¯
              echo "Processing file: $file"
              echo "Title: $title"
              echo "Needs URL: ${{ needs.deploy.outputs.url }}"
              echo "Cover URL: $BASE_URL/$url/cover.png"
              echo "æœ€çµ‚ URL: $BASE_URL/$slug"
              break  # åªè™•ç†ç¬¬ä¸€å€‹è®Šæ›´çš„æª”æ¡ˆ
            fi
          done

      - name: Send Line Message
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          message='{
            "type": "flex",
            "altText": "æ–°æ–‡ç« ç™¼å¸ƒï¼š${{ env.POST_TITLE }}",
            "contents": {
              "type": "bubble",
              "hero": {
                  "type": "image",
                  "url": "${{ env.POST_COVER }}",
                  "size": "full",
                  "aspectRatio": "20:13",
                  "aspectMode": "cover"
              },
              "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "ğŸ‰ æ–°æ–‡ç« ç™¼å¸ƒ",
                    "weight": "bold",
                    "size": "xl"
                  }
                ]
              },
              "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "${{ env.POST_TITLE }}",
                    "wrap": true,
                    "weight": "bold",
                    "size": "md"
                  },
                  {
                    "type": "button",
                    "style": "primary",
                    "action": {
                      "type": "uri",
                      "label": "é–±è®€æ–‡ç« ",
                      "uri": "${{ env.POST_URL }}"
                    },
                    "margin": "md"
                  }
                ]
              }
            }
          }'
          
          curl -X POST https://api.line.me/v2/bot/message/broadcast \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" \
            -d "{
              \"messages\": [$message]
            }"